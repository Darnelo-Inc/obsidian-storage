Загрузка (booting) - это стандартный термин, означающий запуск компьютера. Он представляет собой сокращённую форму слова "самозагрузка" (bootstrapping), которое подразумевает, что компьютер должен "привести себя в рабочее состояние с помощью собственных программ начальной загрузки (bootstraps)".

Процесс загрузки состоит из нескольких задач, определённых в широком смысле:
 - Поиск, ввод в память и запуск кода начальной загрузки
 - Поиск, ввод в память и запуск ядра операционной системы
 - Активирование сценариев запуска и системных демонов
 - Поддержание порядка и управление переходами системы из одного состояния в другое

# 2.1 Обзор процесса загрузки

В Linux используют **systemd** - демон системного менеджера, вместо традиционного демона **init** в UNIX.
Systemd упрощает процесс загрузки путём добавления управления зависимостями, поддержки одновременных процессов запуска и комплексного подхода к протоколированию.

Процесс загрузки Linux и UNIX:
1. Включить
2. Загрузить BIOS/UEFI из NVRAM
3. Собрать сведения об аппаратуре
4. Выбрать устройство для запуска (диск, сеть, ...)
5. Идентифицировать системный раздел EFI
6. Загрузить BIOS/UEFI из NVRAM
7. Определить, какое ядро загрузить
8. Загрузить ядро
9. Создать структуры данных ядра
10. Запустить init/systemd как PID 1
11. Выполнить сценарии запуска
12. Запустить систему

Администратор может изменить только файлы конфигурации и параметры для загрузчиков. Загруженная система - это проверенные смонтированные файловые системы и запущенные системные демоны.

# 2.2 Системные прошивки

При включении компьютера процессор выполняет загрузочный код, хранящийся в ПЗУ, который проверяет аппаратное обеспечение и диски, запуская набор проверок, а затем ищет следующий этап кода начальной загрузки.

Устаревшая прошивка - BIOS. Современный стандарт - UEFI.

## BIOS
Традиционный BIOS (Basic Input/Output System) предполагает, что загрузочное устройство начинается с записи (сектора), называемой MBR (Master Boot Record). MBR содержит первичный загрузчик и простую таблицу разделов диска. Объём свободного места для загрузчика менее 512 байт, поэтому он не может выполнить ничего, кроме загрузки и запуска вторичного загрузчика.

Из-за ограниченного размера ни загрузочный сектор, ни BIOS не могут обрабатывать записи любой стандартной файловой системы, поэтому вторичный загрузчик должен храниться там, где его легко найти. В одном типичном сценарии загрузочный сектор считывает информацию о разбиении диска из MBR и идентифицирует раздел диска, помеченный как "активный". Затем он считывает и выполняет вторичный загрузчик с самого начала этого раздела. Эта схема называется загрузочной записью тома (volume boot record).

В другом сценарии (например, в случае загрузчика GRUB) вторичный загрузчик может находиться в "мёртвой зоне", которая расположена между MBR и началом первого раздела диска. По историческим причинам первый раздел не начинается до 64-го сектора диска, поэтому эта зона обычно содержит минимум 32 Кб памяти, что достаточно для хранения драйвера файловой системы.

MBR ничего не знает про ОС, но т.к. он предполагает определённое местоположение для второго этапа, м.б. установлено несколько версий. Вторичный загрузчик знает об ОС и файловых системах и обычно имеет собственный параметры конфигурации.

## Процесс запуска BIOS

BIOS запускается автоматически при включении компьютера, проходя через следующие этапы:

### 1. Подача питания (Power-On)
- При нажатии кнопки питания электрический ток начинает поступать на материнскую плату
- Срабатывает схема Power-On Self Test (POST)
- Процессор получает сигнал сброса и активируется

### 2. Инициализация процессора
- Процессор начинает работу с предустановленного адреса в памяти (обычно FFFF0h)
- По этому адресу находится программный код BIOS, записанный в микросхеме ROM/EEPROM/Flash

### 3. Выполнение POST (Power-On Self Test)
- BIOS проверяет основное оборудование:
  - Процессор
  - Оперативную память (RAM)
  - Видеокарту
  - Клавиатуру
  - Накопители данных
- При обнаружении ошибок выдаются звуковые сигналы или коды ошибок на экране

### 4. Инициализация устройств
- BIOS обнаруживает и инициализирует подключенные устройства
- Загружает драйверы для базовых устройств
- Устанавливает параметры работы оборудования согласно настройкам

### 5. Загрузка операционной системы
- BIOS ищет загрузочное устройство согласно установленной последовательности загрузки (Boot Sequence)
- Считывает первый сектор загрузочного устройства (MBR/GPT)
- Передает управление загрузчику операционной системы


## UEFI
## Процесс запуска UEFI (Unified Extensible Firmware Interface)

## 1. Включение питания компьютера (Power-On)
- Подача электроэнергии на материнскую плату
- Активация цепей питания и начальная стабилизация напряжения
- Сброс процессора и подготовка к выполнению кода

### 2. Фазы инициализации UEFI

#### 2.1. SEC фаза (Security Phase)
- Самый ранний этап загрузки UEFI
- Инициализация временной памяти и основных компонентов
- Верификация целостности прошивки (при наличии функции Secure Boot)

#### 2.2. PEI фаза (Pre-EFI Initialization)
- Инициализация основных компонентов системы
- Обнаружение и инициализация оперативной памяти
- Подготовка к запуску основных модулей UEFI

#### 2.3. DXE фаза (Driver Execution Environment)
- Загрузка и выполнение драйверов UEFI
- Инициализация всех аппаратных компонентов
- Построение таблиц конфигурации для операционной системы
- Выполнение POST (Power-On Self Test) для проверки оборудования

### 3. Работа с диском и загрузочными разделами

#### 3.1. BDS фаза (Boot Device Selection)
- Считывание таблицы разделов GPT с диска
- Поиск в GPT раздела ESP (EFI System Partition) с определенным GUID
- Выбор загрузочного устройства согласно настроенной последовательности
- Обработка правил Secure Boot (если включено)

#### 3.2. Поиск и загрузка EFI-приложений
- UEFI работает с ESP, который отформатирован в файловой системе FAT32/FAT16/FAT12
- Поиск загрузочных файлов по стандартным путям:
  - /EFI/BOOT/BOOTX64.EFI (для x64 систем)
  - /EFI/Microsoft/Boot/bootmgfw.efi (для Windows)
  - /EFI/ubuntu/grubx64.efi (для Ubuntu Linux)
- Прямая загрузка выбранного EFI-файла в память
- Проверка цифровой подписи EFI-приложения (если включен Secure Boot)

### 4. Переход к загрузке операционной системы

#### 4.1. TSL фаза (Transient System Load)
- Выполнение одного из двух возможных сценариев:
  - Прямая загрузка ядра: если ядро ОС скомпилировано как EFI-приложение (например, Linux с EFISTUB)
  - Использование загрузчика: загрузка промежуточного загрузчика (GRUB, Windows Boot Manager), который затем загружает ядро ОС

#### 4.2. RT фаза (Runtime Phase)
- UEFI переходит в режим выполнения Runtime Services
- Предоставление сервисов для операционной системы
- ОС получает полный контроль над системой

### 5. Преимущества системы UEFI+GPT
- ESP доступен из любой ОС как обычный FAT-раздел
- Отсутствие скрытых загрузочных секторов (MBR), что повышает безопасность
- Возможность мультизагрузки разных ОС с одной таблицей GPT
- Поддержка дисков более 2ТБ (в отличие от MBR)
- Резервное копирование первичной GPT в конце диска для восстановления

В данном процессе UEFI обеспечивает более современный, безопасный и гибкий подход к загрузке системы по сравнению с устаревшим BIOS+MBR.

UEFI имеет API, с помощью которого можно изменить порядок загрузки. E.g. `sudo efibootmgr -o 0004,0002`


# 2.3 Загрузчики

## Загрузчики операционных систем: между прошивкой и ядром

Загрузчики операционных систем занимают промежуточное положение между прошивкой компьютера (BIOS/UEFI) и ядром операционной системы, выполняя критически важные функции, которые ни прошивка, ни ядро обеспечить не могут.

## Основные задачи загрузчиков

### 1. Загрузка ядра ОС
- Поиск и загрузка ядра операционной системы в оперативную память
- Определение местоположения ядра с учетом файловой системы
- Поддержка различных файловых систем (ext4, NTFS, XFS, Btrfs и т.д.), в отличие от UEFI, который обычно понимает только FAT

### 2. Маршалинг (подготовка среды для ядра)
- Настройка начальной среды выполнения для ядра
- Передача параметров запуска ядру (например, опции командной строки)
- Загрузка начального RAM-диска (initrd/initramfs) с драйверами и начальными скриптами
- Настройка видеорежима и других аппаратных параметров
- Заполнение структур данных, необходимых ядру для инициализации

### 3. Дополнительные функции
- Обеспечение мультизагрузки (выбор между различными ОС)
- Предоставление меню с опциями загрузки
- Загрузка альтернативных версий ядра (например, для восстановления)
- Выполнение базовой диагностики оборудования
- Загрузка модулей, необходимых для раннего распознавания оборудования

# 2.4 GRUB (Grand Unified Bootloader)

GRUB является одним из наиболее популярных и мощных загрузчиков, особенно в экосистеме Linux. В настоящее время широко используется GRUB 2, пришедший на смену оригинальному GRUB (теперь называемому GRUB Legacy).

## Особенности GRUB

- Модульная архитектура: состоит из нескольких стадий загрузки
- Универсальность: поддерживает множество ОС и файловых систем
- Интерактивность: предоставляет меню и командную строку
- Поддержка различных методов загрузки: через BIOS и UEFI
- Расширяемость: может быть расширен модулями

## Конфигурация GRUB 2

Конфигурация GRUB 2 в системах Linux обычно включает несколько уровней:

### 1. Основные файлы конфигурации:

- /boot/grub/grub.cfg - основной файл конфигурации (не редактируется напрямую)
- /etc/default/grub - главный файл настроек (пользовательские параметры)
- Скрипты в /etc/grub.d/ - определяют автоматическое создание конфигурации

### 2. Управление файлом /etc/default/grub:
#### Время ожидания выбора в меню (в секундах)
`GRUB_TIMEOUT=5`

#### Загружаемая по умолчанию позиция
`GRUB_DEFAULT=0`

#### Параметры командной строки ядра
`GRUB_CMDLINE_LINUX="quiet splash"`

#### Параметры для восстановительного режима
`GRUB_CMDLINE_LINUX_DEFAULT=""`

#### Настройки графического интерфейса
`GRUB_GFXMODE=1024x768`

#### Скрытие меню загрузки
`GRUB_HIDDEN_TIMEOUT=0`

#### Поиск других ОС
`GRUB_DISABLE_OS_PROBER=false`

### 3. Скрипты в /etc/grub.d/:

- 00_header - основные настройки и функции
- 10_linux - обнаружение ядер Linux
- 20_memtest86+ - опция для тестирования памяти
- 30_os-prober - обнаружение других ОС
- 40_custom - пользовательские записи меню
- 41_custom - дополнительный файл для пользовательских записей

### 4. Обновление конфигурации:

После изменения настроек необходимо выполнить команду для генерации нового grub.cfg:
`sudo update-grub  # Debian/Ubuntu`
или
`sudo grub-mkconfig -o /boot/grub/grub.cfg  # Другие дистрибутивы`

## Примеры пользовательских записей GRUB

Запись для загрузки Linux в файле /etc/grub.d/40_custom:
```shell
menuentry "Мой особый Linux" {
    set root=(hd0,1)
    linux /boot/vmlinuz-5.15.0 root=/dev/sda1 ro quiet splash
    initrd /boot/initrd.img-5.15.0
}
```
Запись для загрузки Windows:
```shell
menuentry "Windows 10" {
    insmod ntfs
    set root=(hd0,3)
    chainloader +1
}
```
## Расширенные возможности GRUB

- Шифрование - защита загрузки паролем
- Загрузка с сети (PXE)
- Загрузка с ISO-образов
- Поддержка LVM, RAID, LUKS - работа со сложными схемами хранения данных
- Восстановление системы - возможность загрузки в аварийном режиме
- Пользовательские модули - расширение функциональности

## Другие популярные загрузчики

- LILO (Linux Loader) - исторический загрузчик для Linux
- SYSLINUX - набор загрузчиков для различных сценариев (особенно полезен для загрузки с USB)
- Windows Boot Manager - загрузчик Windows
- rEFInd - графический загрузчик с акцентом на простоту использования
- U-Boot - популярный загрузчик для встраиваемых систем

## Разница между BIOS/UEFI, загрузчиком и ядром

- BIOS/UEFI - низкоуровневая прошивка, специфичная для оборудования, не понимает сложные файловые системы ОС
- Загрузчик - "мост" между прошивкой и ядром, понимает файловые системы и структуру ОС, но не управляет системой
- Ядро - центральный компонент ОС, управляющий всеми ресурсами системы после полной инициализации

"Прямой запуск загрузчика" без BIOS/UEFI невозможен по фундаментальным техническим причинам. Это аналогично попытке включить автомобильный двигатель без стартера - теоретически мотор способен работать сам по себе, но что-то должно выполнить первоначальный запуск, когда все системы находятся в неактивном состоянии.

# 2.5 Процесс загрузки FreeBSD

## Общий обзор процесса загрузки

Процесс загрузки FreeBSD состоит из нескольких последовательных этапов:

1. **BIOS/UEFI** — первичный загрузчик, встроенный в оборудование
2. **Загрузчик 1-й стадии** (boot0, boot1, или UEFI loader)
3. **Загрузчик 2-й стадии** (boot2 для BIOS систем)
4. **Загрузчик 3-й стадии** (loader)
5. **Запуск ядра** и инициализация системы

## Загрузка в режиме BIOS с boot0

### boot0 (MBR-загрузчик первой стадии)

**boot0** — это простой загрузчик размером 512 байт, располагающийся в главной загрузочной записи (MBR) и предназначенный для систем с мультизагрузкой.

**Основные характеристики:**
- Устанавливается командой boot0cfg
- Отображает меню выбора ОС при запуске
- Очень ограниченная функциональность из-за размера 512 байт
- Не понимает файловую систему

**Процесс работы boot0:**
1. BIOS загружает boot0 из MBR
2. boot0 отображает меню выбора раздела для загрузки
3. После выбора загружает первый сектор (boot1) активного раздела

**Установка boot0:**
boot0cfg -B /dev/ada0

### boot1 (загрузчик раздела)

После boot0 загружается **boot1** — загрузчик, который находится в первом секторе раздела FreeBSD. Он имеет базовое понимание файловой системы UFS и может загрузить **boot2**.

### boot2 (загрузчик второй стадии)

**boot2** имеет лучшее понимание файловой системы FreeBSD и загружает **loader** (3-я стадия):
- Находится в /boot/boot2
- Содержит код для чтения UFS
- Загружает loader из файловой системы (/boot/loader)

## Загрузка в режиме UEFI

В системах UEFI процесс загрузки отличается от традиционного BIOS:

1. **Прошивка UEFI** инициализирует оборудование
2. **Загрузчик UEFI FreeBSD** (**boot1.efi**) загружается из ESP (EFI System Partition)
3. **loader.efi** загружается без промежуточного этапа boot2

**Особенности UEFI-загрузки:**
- Использует разделы GPT вместо MBR
- Требует ESP-раздел (обычно /dev/ada0p1) с файловой системой FAT32
- Загрузчик находится в /boot/loader.efi
- Путь к загрузчику в ESP: /EFI/FreeBSD/loader.efi

**Настройка UEFI-загрузки:**
# Создание ESP и установка загрузчика
gpart add -t efi -s 200M ada0
newfs_msdos /dev/ada0p1
mkdir /mnt/efi
mount -t msdosfs /dev/ada0p1 /mnt/efi
mkdir -p /mnt/efi/EFI/FreeBSD
cp /boot/loader.efi /mnt/efi/EFI/FreeBSD/

**Регистрация в UEFI:**
efibootmgr -c -l /EFI/FreeBSD/loader.efi -L "FreeBSD"

## Загрузчик третьей стадии (loader)

**loader** — это основной загрузчик FreeBSD, обеспечивающий интерактивный интерфейс и загрузку ядра:

**Характеристики:**
- Интерпретатор Forth для интерактивного управления
- Поддержка модулей ядра (KLDs)
- Загрузка конфигурационных файлов
- Интерактивный режим для отладки и настройки

### Конфигурация loader

**Основные конфигурационные файлы:**
- /boot/defaults/loader.conf — файл с настройками по умолчанию (не рекомендуется редактировать)
- /boot/loader.conf — пользовательский файл настроек (рекомендуется использовать)
- /boot/loader.conf.local — дополнительный локальный файл настроек

**Пример содержимого /boot/loader.conf:**
#### Загрузка файловой системы ZFS
zfs_load="YES"

#### Настройка консоли
loader_logo="beastie"
autoboot_delay="5"
loader_color="YES"

#### Настройки ядра
kern.maxproc="2500"
hw.pci.do_power_nodriver="3"

#### Загрузка модулей
coretemp_load="YES"
linprocfs_load="YES"

### Команды загрузчика loader

В интерактивном режиме loader поддерживает множество команд:

**Основные команды:**
- boot [флаги] — загрузка ядра с указанными флагами
- boot -s — загрузка в однопользовательском режиме
- boot -v — подробный режим загрузки
- show — показать все переменные среды
- set variable=value — установить значение переменной
- unset variable — удалить переменную
- load [module] — загрузить модуль ядра
- unload [module] — выгрузить модуль ядра
- ls [path] — список файлов
- lsmod — список загруженных модулей
- help [command] — справка по командам
- reboot — перезагрузка системы
- autoboot [seconds] — автоматическая

# 2.6 Демоны управления системы